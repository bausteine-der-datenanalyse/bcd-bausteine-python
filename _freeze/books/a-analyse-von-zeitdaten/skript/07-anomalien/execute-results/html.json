{
  "hash": "2da797b4815f3deb843bbc292e1a03b3",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"7 Anomalien\"\n---\n\n# 7 Anomalien\n\nAnomalien sind Beobachtungen, die deutlich vom erwarteten Verhalten abweichen.\n\nIn Zeitreihen bedeutet das:\n\n- starke Abweichung vom Trend\n- starke Abweichung von saisonalem Muster\n- plötzliche Strukturbrüche\n\nWichtig ist: Anomalien sind **kontextabhängig**.\n\n---\n\n::: {.callout-note title=\"Merke\"}\nEine Anomalie ist keine rein statistische Eigenschaft.\nSie ist eine Abweichung vom erwarteten Prozessverhalten.\n:::\n\n---\n\n## 7.1 Beispielsignal mit Ausreißern\n\n::: {#883270ed .cell execution_count=1}\n``` {.python .cell-code}\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\nrng = np.random.default_rng(99)\n\nt = pd.date_range(\"2025-01-01\", periods=24*10, freq=\"H\")\ntrend = np.linspace(0, 2, len(t))\nseason = 0.8 * np.sin(2*np.pi*(t.hour)/24)\nnoise = 0.3 * rng.normal(size=len(t))\n\ns = pd.Series(10 + trend + season + noise, index=t, name=\"signal\")\n\n# künstliche Anomalien\ns.iloc[40] += 4\ns.iloc[120] -= 3\n\ns.plot(title=\"Signal mit Anomalien\")\nplt.show()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/p_/ks3trxjx0jd839_g4g0vm4nc0000gn/T/ipykernel_21381/2246874237.py:7: FutureWarning: 'H' is deprecated and will be removed in a future version, please use 'h' instead.\n  t = pd.date_range(\"2025-01-01\", periods=24*10, freq=\"H\")\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](07-anomalien_files/figure-html/cell-2-output-2.png){}\n:::\n:::\n\n\n---\n\n## 7.2 Globale Z-Score Methode\n\nWir standardisieren die gesamte Zeitreihe.\n\n::: {.panel-tabset}\n\n## Pandas\n\n::: {#125c8f08 .cell execution_count=2}\n``` {.python .cell-code}\nz = (s - s.mean()) / s.std()\nanomalies = s[abs(z) > 3]\n\nax = s.plot(label=\"Signal\")\nanomalies.plot(ax=ax, linestyle=\"None\", marker=\"o\", label=\"Anomalie\")\nplt.legend()\nplt.title(\"Anomalien (Z-Score)\")\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](07-anomalien_files/figure-html/cell-3-output-1.png){}\n:::\n:::\n\n\n## NumPy\n\n::: {#94936038 .cell execution_count=3}\n``` {.python .cell-code}\ny = s.to_numpy()\n\nz_np = (y - np.mean(y)) / np.std(y)\nanomalies_idx = np.where(np.abs(z_np) > 3)[0]\n\nplt.plot(y, label=\"Signal\")\nplt.scatter(anomalies_idx, y[anomalies_idx], label=\"Anomalie\")\nplt.legend()\nplt.title(\"Anomalien (NumPy Z-Score)\")\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](07-anomalien_files/figure-html/cell-4-output-1.png){}\n:::\n:::\n\n\n:::\n\n---\n\n::: {.callout-warning title=\"Achtung\"}\nZ-Score funktioniert schlecht bei starkem Trend oder Saison,\nweil globale Mittelwerte verzerren.\n:::\n\n---\n\n## 7.3 Lokale Anomalie (Baseline + Residuum)\n\nStatt globaler Standardisierung definieren wir eine lokale Baseline.\n\n::: {#01c9f190 .cell execution_count=4}\n``` {.python .cell-code}\nbaseline = s.ewm(span=24, adjust=False).mean()\nresidual = s - baseline\n\nscore = (residual - residual.mean()) / residual.std()\nanomalies_local = s[abs(score) > 3]\n\nax = s.plot(alpha=0.6, label=\"Signal\")\nbaseline.plot(ax=ax, label=\"Baseline\")\nanomalies_local.plot(ax=ax, linestyle=\"None\", marker=\"o\", label=\"Anomalie\")\nplt.legend()\nplt.title(\"Lokale Anomalien (EWMA-Baseline)\")\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](07-anomalien_files/figure-html/cell-5-output-1.png){}\n:::\n:::\n\n\n---\n\n::: {.callout-tip title=\"Interpretation\"}\nLokale Verfahren sind robuster,\nwenn Trend oder Saison vorhanden sind.\n:::\n\n---\n\n## 7.4 Rolling-Standardabweichung\n\nAnomalien können auch als starke Abweichung\nrelativ zur lokalen Varianz definiert werden.\n\n::: {#1414f5d6 .cell execution_count=5}\n``` {.python .cell-code}\nrolling_std = s.rolling(\"24H\").std()\nrolling_mean = s.rolling(\"24H\").mean()\n\nupper = rolling_mean + 3 * rolling_std\nlower = rolling_mean - 3 * rolling_std\n\nax = s.plot(label=\"Signal\")\nupper.plot(ax=ax, linestyle=\"--\", label=\"Upper Bound\")\nlower.plot(ax=ax, linestyle=\"--\", label=\"Lower Bound\")\nplt.legend()\nplt.title(\"Anomalien via Rolling-Bounds\")\nplt.show()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/p_/ks3trxjx0jd839_g4g0vm4nc0000gn/T/ipykernel_21381/2083333883.py:1: FutureWarning: 'H' is deprecated and will be removed in a future version, please use 'h' instead.\n  rolling_std = s.rolling(\"24H\").std()\n/var/folders/p_/ks3trxjx0jd839_g4g0vm4nc0000gn/T/ipykernel_21381/2083333883.py:2: FutureWarning: 'H' is deprecated and will be removed in a future version, please use 'h' instead.\n  rolling_mean = s.rolling(\"24H\").mean()\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](07-anomalien_files/figure-html/cell-6-output-2.png){}\n:::\n:::\n\n\n---\n\n## 7.5 Strukturbruch vs Ausreißer\n\nEin einzelner Peak → Ausreißer  \nDauerhafte Niveauänderung → Strukturbruch\n\nBeide erfordern unterschiedliche Interpretation.\n\n---\n\n::: {.callout-note title=\"Methodischer Hinweis\"}\nBevor Sie Anomalien markieren:\n\n1. Trend prüfen  \n2. Saison prüfen  \n3. Baseline definieren  \n4. Schwellenwert begründen  \n:::\n\n---\n\n## 7.6 Mini-Aufgaben\n\n1. Entfernen Sie den Trend vor Anwendung des Z-Scores.  \n   - Wie verändert sich das Ergebnis?\n\n2. Verringern Sie den Schwellenwert von 3 auf 2.  \n   - Was passiert?\n\n3. Simulieren Sie einen dauerhaften Niveau-Sprung.  \n   - Wird dieser als Anomalie erkannt?\n\n",
    "supporting": [
      "07-anomalien_files"
    ],
    "filters": [],
    "includes": {}
  }
}